local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local TextService = game:GetService("TextService")
local SoundService = game:GetService("SoundService")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local Utility = {}

function Utility.Create(className, properties, children)
    local instance = Instance.new(className)
    for prop, value in pairs(properties) do
        if prop ~= "Parent" then
            pcall(function()
                instance[prop] = value
            end)
        end
    end
    if children then
        for _, child in ipairs(children) do
            child.Parent = instance
        end
    end
    if properties.Parent then
        instance.Parent = properties.Parent
    end
    return instance
end

function Utility.Tween(instance, properties, duration, easingStyle, easingDirection)
    local tweenInfo = TweenInfo.new(
        duration or 0.25,
        easingStyle or Enum.EasingStyle.Sine,
        easingDirection or Enum.EasingDirection.Out
    )
    local tween = TweenService:Create(instance, tweenInfo, properties)
    tween:Play()
    return tween
end

function Utility.Ripple(button, color)
    local rippleColor = color or Color3.fromRGB(255, 255, 255)
    local mousePos = UserInputService:GetMouseLocation()
    local absPos = button.AbsolutePosition
    local absSize = button.AbsoluteSize

    local ripple = Utility.Create("Frame", {
        Parent = button,
        BackgroundColor3 = rippleColor,
        BackgroundTransparency = 0.7,
        Position = UDim2.new(0, mousePos.X - absPos.X, 0, mousePos.Y - absPos.Y - 36),
        Size = UDim2.new(0, 0, 0, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        ZIndex = button.ZIndex + 1,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(1, 0) })
    })

    local maxSize = math.max(absSize.X, absSize.Y) * 2.5
    local tween = Utility.Tween(ripple, {
        Size = UDim2.new(0, maxSize, 0, maxSize),
        BackgroundTransparency = 1
    }, 0.5, Enum.EasingStyle.Quad)

    tween.Completed:Connect(function()
        ripple:Destroy()
    end)
end

function Utility.MakeDraggable(topBar, mainFrame)
    local dragging = false
    local dragInput = nil
    local dragStart = nil
    local startPos = nil
    local connections = {}

    table.insert(connections, topBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position

            local conn
            conn = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if conn then conn:Disconnect() end
                end
            end)
            table.insert(connections, conn)
        end
    end))

    table.insert(connections, topBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end))

    table.insert(connections, UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging and dragStart and startPos then
            local delta = input.Position - dragStart
            Utility.Tween(mainFrame, {
                Position = UDim2.new(
                    startPos.X.Scale,
                    startPos.X.Offset + delta.X,
                    startPos.Y.Scale,
                    startPos.Y.Offset + delta.Y
                )
            }, 0.08)
        end
    end))

    return connections
end

function Utility.AddSound(soundId, volume)
    pcall(function()
        local sound = Instance.new("Sound")
        sound.SoundId = soundId
        sound.Volume = volume or 0.5
        sound.Parent = SoundService
        sound:Play()
        sound.Ended:Connect(function()
            sound:Destroy()
        end)
    end)
end

function Utility.DeepCopy(original)
    if type(original) ~= "table" then return original end
    local copy = {}
    for key, value in pairs(original) do
        copy[Utility.DeepCopy(key)] = Utility.DeepCopy(value)
    end
    return copy
end

local Themes = {
    Dark = {
        Background = Color3.fromRGB(18, 18, 28),
        SecondaryBackground = Color3.fromRGB(25, 25, 38),
        TertiaryBackground = Color3.fromRGB(32, 32, 48),
        Sidebar = Color3.fromRGB(14, 14, 22),
        Accent = Color3.fromRGB(0, 170, 255),
        AccentDark = Color3.fromRGB(0, 130, 200),
        Text = Color3.fromRGB(240, 240, 245),
        TextDark = Color3.fromRGB(160, 160, 180),
        TextDimmed = Color3.fromRGB(100, 100, 120),
        Border = Color3.fromRGB(45, 45, 65),
        Shadow = Color3.fromRGB(0, 0, 0),
        Success = Color3.fromRGB(80, 200, 120),
        Warning = Color3.fromRGB(255, 180, 50),
        Error = Color3.fromRGB(255, 80, 80),
        Info = Color3.fromRGB(0, 170, 255),
        ToggleOn = Color3.fromRGB(0, 170, 255),
        ToggleOff = Color3.fromRGB(60, 60, 80),
        SliderFill = Color3.fromRGB(0, 170, 255),
        SliderBackground = Color3.fromRGB(40, 40, 60),
        InputBackground = Color3.fromRGB(28, 28, 42),
        HoverOverlay = Color3.fromRGB(255, 255, 255),
        GlowEnabled = false,
        GlassEnabled = false,
        ElementTransparency = 0.5,
        ElementStrokeColor = Color3.fromRGB(45, 45, 65),
        ElementStrokeTransparency = 0.6,
        ButtonHover = Color3.fromRGB(50, 50, 70),
        RibbonEnabled = false,
        RibbonColor = Color3.fromRGB(0, 0, 0),
    },
    Light = {
        Background = Color3.fromRGB(240, 240, 248),
        SecondaryBackground = Color3.fromRGB(230, 230, 240),
        TertiaryBackground = Color3.fromRGB(220, 220, 232),
        Sidebar = Color3.fromRGB(248, 248, 255),
        Accent = Color3.fromRGB(0, 120, 215),
        AccentDark = Color3.fromRGB(0, 90, 170),
        Text = Color3.fromRGB(20, 20, 30),
        TextDark = Color3.fromRGB(80, 80, 100),
        TextDimmed = Color3.fromRGB(140, 140, 160),
        Border = Color3.fromRGB(200, 200, 215),
        Shadow = Color3.fromRGB(180, 180, 200),
        Success = Color3.fromRGB(50, 170, 90),
        Warning = Color3.fromRGB(220, 150, 30),
        Error = Color3.fromRGB(220, 60, 60),
        Info = Color3.fromRGB(0, 120, 215),
        ToggleOn = Color3.fromRGB(0, 120, 215),
        ToggleOff = Color3.fromRGB(180, 180, 200),
        SliderFill = Color3.fromRGB(0, 120, 215),
        SliderBackground = Color3.fromRGB(200, 200, 215),
        InputBackground = Color3.fromRGB(245, 245, 252),
        HoverOverlay = Color3.fromRGB(0, 0, 0),
        GlowEnabled = false,
        GlassEnabled = false,
        ElementTransparency = 0.5,
        ElementStrokeColor = Color3.fromRGB(200, 200, 215),
        ElementStrokeTransparency = 0.6,
        ButtonHover = Color3.fromRGB(210, 210, 225),
        RibbonEnabled = false,
        RibbonColor = Color3.fromRGB(0, 0, 0),
    },
    Glossy = {
        Background = Color3.fromRGB(12, 12, 20),
        SecondaryBackground = Color3.fromRGB(20, 20, 35),
        TertiaryBackground = Color3.fromRGB(30, 30, 50),
        Sidebar = Color3.fromRGB(8, 8, 16),
        Accent = Color3.fromRGB(120, 80, 255),
        AccentDark = Color3.fromRGB(90, 50, 200),
        Text = Color3.fromRGB(245, 245, 255),
        TextDark = Color3.fromRGB(180, 170, 210),
        TextDimmed = Color3.fromRGB(120, 110, 150),
        Border = Color3.fromRGB(80, 60, 140),
        Shadow = Color3.fromRGB(0, 0, 0),
        Success = Color3.fromRGB(100, 230, 140),
        Warning = Color3.fromRGB(255, 200, 60),
        Error = Color3.fromRGB(255, 90, 90),
        Info = Color3.fromRGB(120, 80, 255),
        ToggleOn = Color3.fromRGB(120, 80, 255),
        ToggleOff = Color3.fromRGB(50, 40, 80),
        SliderFill = Color3.fromRGB(120, 80, 255),
        SliderBackground = Color3.fromRGB(35, 30, 60),
        InputBackground = Color3.fromRGB(18, 16, 32),
        HoverOverlay = Color3.fromRGB(255, 255, 255),
        GlowEnabled = true,
        GlassEnabled = false,
        ElementTransparency = 0.4,
        ElementStrokeColor = Color3.fromRGB(120, 80, 255),
        ElementStrokeTransparency = 0.4,
        ButtonHover = Color3.fromRGB(60, 40, 100),
        RibbonEnabled = false,
        RibbonColor = Color3.fromRGB(0, 0, 0),
    },
    Glass = {
        Background = Color3.fromRGB(15, 15, 25),
        SecondaryBackground = Color3.fromRGB(25, 25, 40),
        TertiaryBackground = Color3.fromRGB(35, 35, 55),
        Sidebar = Color3.fromRGB(10, 10, 18),
        Accent = Color3.fromRGB(0, 200, 220),
        AccentDark = Color3.fromRGB(0, 160, 180),
        Text = Color3.fromRGB(230, 240, 255),
        TextDark = Color3.fromRGB(150, 170, 200),
        TextDimmed = Color3.fromRGB(90, 110, 140),
        Border = Color3.fromRGB(255, 255, 255),
        Shadow = Color3.fromRGB(0, 0, 0),
        Success = Color3.fromRGB(80, 220, 130),
        Warning = Color3.fromRGB(255, 190, 50),
        Error = Color3.fromRGB(255, 85, 85),
        Info = Color3.fromRGB(0, 200, 220),
        ToggleOn = Color3.fromRGB(0, 200, 220),
        ToggleOff = Color3.fromRGB(50, 60, 80),
        SliderFill = Color3.fromRGB(0, 200, 220),
        SliderBackground = Color3.fromRGB(40, 50, 70),
        InputBackground = Color3.fromRGB(20, 25, 40),
        HoverOverlay = Color3.fromRGB(255, 255, 255),
        GlowEnabled = true,
        GlassEnabled = true,
        ElementTransparency = 0.7,
        ElementStrokeColor = Color3.fromRGB(255, 255, 255),
        ElementStrokeTransparency = 0.3,
        ButtonHover = Color3.fromRGB(50, 60, 90),
        RibbonEnabled = false,
        RibbonColor = Color3.fromRGB(0, 0, 0),
    },
    Christmas = {
        Background = Color3.fromRGB(10, 28, 12),
        SecondaryBackground = Color3.fromRGB(15, 40, 18),
        TertiaryBackground = Color3.fromRGB(22, 55, 26),
        Sidebar = Color3.fromRGB(8, 22, 10),
        Accent = Color3.fromRGB(200, 30, 30),
        AccentDark = Color3.fromRGB(160, 20, 20),
        Text = Color3.fromRGB(240, 245, 240),
        TextDark = Color3.fromRGB(160, 200, 165),
        TextDimmed = Color3.fromRGB(100, 140, 105),
        Border = Color3.fromRGB(40, 80, 45),
        Shadow = Color3.fromRGB(0, 0, 0),
        Success = Color3.fromRGB(80, 200, 100),
        Warning = Color3.fromRGB(255, 200, 50),
        Error = Color3.fromRGB(220, 50, 50),
        Info = Color3.fromRGB(200, 30, 30),
        ToggleOn = Color3.fromRGB(200, 30, 30),
        ToggleOff = Color3.fromRGB(30, 60, 35),
        SliderFill = Color3.fromRGB(200, 30, 30),
        SliderBackground = Color3.fromRGB(25, 50, 28),
        InputBackground = Color3.fromRGB(12, 32, 15),
        HoverOverlay = Color3.fromRGB(255, 255, 255),
        GlowEnabled = false,
        GlassEnabled = false,
        ElementTransparency = 0.5,
        ElementStrokeColor = Color3.fromRGB(40, 80, 45),
        ElementStrokeTransparency = 0.5,
        ButtonHover = Color3.fromRGB(180, 25, 25),
        RibbonEnabled = true,
        RibbonColor = Color3.fromRGB(200, 30, 30),
    },
}

local KyuuLibrary = {}
KyuuLibrary.__index = KyuuLibrary
KyuuLibrary.Windows = {}
KyuuLibrary.Connections = {}
KyuuLibrary.SoundsEnabled = true
KyuuLibrary.AccentColor = Color3.fromRGB(0, 170, 255)
KyuuLibrary.ScreenGui = nil
KyuuLibrary.NotificationContainer = nil
KyuuLibrary.CustomKeybinds = {}
KyuuLibrary.GlobalToggleKey = Enum.KeyCode.Z

local function writefileCompat(path, data)
    if writefile then
        writefile(path, data)
    end
end

local function readfileCompat(path)
    if readfile then
        local success, result = pcall(readfile, path)
        if success then return result end
    end
    return nil
end

local function isfileCompat(path)
    if isfile then
        return isfile(path)
    end
    return false
end

local function makeFolderCompat(path)
    if makefolder then
        pcall(makefolder, path)
    end
end

function KyuuLibrary:Init()
    if self.ScreenGui then return end

    local guiParent = CoreGui
    pcall(function()
        if syn and syn.protect_gui then
        elseif gethui then
            guiParent = gethui()
        end
    end)

    self.ScreenGui = Utility.Create("ScreenGui", {
        Name = "KyuuLibrary_" .. HttpService:GenerateGUID(false),
        Parent = guiParent,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false,
        DisplayOrder = 999,
        IgnoreGuiInset = true,
    })

    pcall(function()
        if syn and syn.protect_gui then
            syn.protect_gui(self.ScreenGui)
        end
    end)

    self.NotificationContainer = Utility.Create("Frame", {
        Parent = self.ScreenGui,
        Name = "NotificationContainer",
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -20, 0, 20),
        Size = UDim2.new(0, 320, 1, -40),
        AnchorPoint = Vector2.new(1, 0),
        ZIndex = 10000,
    }, {
        Utility.Create("UIListLayout", {
            Padding = UDim.new(0, 8),
            FillDirection = Enum.FillDirection.Vertical,
            HorizontalAlignment = Enum.HorizontalAlignment.Right,
            VerticalAlignment = Enum.VerticalAlignment.Bottom,
            SortOrder = Enum.SortOrder.LayoutOrder,
        })
    })

    local globalKeybindConn = UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == self.GlobalToggleKey then
                for _, window in ipairs(self.Windows) do
                    window:Toggle()
                end
            end
            for _, kb in ipairs(self.CustomKeybinds) do
                if input.KeyCode == kb.Key then
                    pcall(kb.Callback)
                end
            end
        end
    end)
    table.insert(self.Connections, globalKeybindConn)

    return self
end

function KyuuLibrary:BindKey(name, key, callback)
    for i, kb in ipairs(self.CustomKeybinds) do
        if kb.Name == name then
            self.CustomKeybinds[i] = { Name = name, Key = key, Callback = callback }
            return
        end
    end
    table.insert(self.CustomKeybinds, { Name = name, Key = key, Callback = callback })
end

function KyuuLibrary:UnbindKey(name)
    for i, kb in ipairs(self.CustomKeybinds) do
        if kb.Name == name then
            table.remove(self.CustomKeybinds, i)
            return
        end
    end
end

function KyuuLibrary:SetToggleKey(key)
    self.GlobalToggleKey = key
end

function KyuuLibrary:Notify(config)
    self:Init()
    local title = config.Title or "Notification"
    local content = config.Content or ""
    local duration = config.Duration or 4
    local notifType = config.Type or "Info"

    local theme = Themes.Dark
    local typeColors = {
        Success = theme.Success,
        Warning = theme.Warning,
        Error = theme.Error,
        Info = theme.Info,
    }
    local accentColor = typeColors[notifType] or theme.Accent

    local typeIcons = {
        Success = "‚úì",
        Warning = "‚ö†",
        Error = "‚úï",
        Info = "‚Ñπ",
    }
    local icon = typeIcons[notifType] or "‚Ñπ"

    local notifFrame = Utility.Create("Frame", {
        Parent = self.NotificationContainer,
        Name = "Notification",
        BackgroundColor3 = theme.SecondaryBackground,
        Size = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
        ClipsDescendants = true,
        BackgroundTransparency = 0.05,
        ZIndex = 10001,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 10) }),
        Utility.Create("UIStroke", {
            Color = theme.Border,
            Thickness = 1,
            Transparency = 0.5,
        }),
        Utility.Create("UIPadding", {
            PaddingTop = UDim.new(0, 12),
            PaddingBottom = UDim.new(0, 12),
            PaddingLeft = UDim.new(0, 14),
            PaddingRight = UDim.new(0, 14),
        }),
    })

    Utility.Create("Frame", {
        Parent = notifFrame,
        Name = "AccentBar",
        BackgroundColor3 = accentColor,
        Size = UDim2.new(0, 3, 1, -24),
        Position = UDim2.new(0, -10, 0, 12),
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 2) })
    })

    Utility.Create("TextLabel", {
        Parent = notifFrame,
        Name = "Icon",
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 24, 0, 24),
        Position = UDim2.new(0, 2, 0, 0),
        Text = icon,
        TextColor3 = accentColor,
        TextSize = 18,
        Font = Enum.Font.GothamBold,
        ZIndex = 10002,
    })

    Utility.Create("TextLabel", {
        Parent = notifFrame,
        Name = "Title",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -36, 0, 20),
        Position = UDim2.new(0, 32, 0, 0),
        Text = title,
        TextColor3 = theme.Text,
        TextSize = 15,
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        ZIndex = 10002,
    })

    if content ~= "" then
        Utility.Create("TextLabel", {
            Parent = notifFrame,
            Name = "Content",
            BackgroundTransparency = 1,
            Size = UDim2.new(1, -36, 0, 0),
            Position = UDim2.new(0, 32, 0, 24),
            AutomaticSize = Enum.AutomaticSize.Y,
            Text = content,
            TextColor3 = theme.TextDark,
            TextSize = 13,
            Font = Enum.Font.Gotham,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextWrapped = true,
            ZIndex = 10002,
        })
    end

    local progressBarBg = Utility.Create("Frame", {
        Parent = notifFrame,
        Name = "ProgressBg",
        BackgroundColor3 = theme.TertiaryBackground,
        Size = UDim2.new(1, 4, 0, 3),
        Position = UDim2.new(0, -2, 1, 8),
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 2) })
    })

    local progressBar = Utility.Create("Frame", {
        Parent = progressBarBg,
        Name = "Fill",
        BackgroundColor3 = accentColor,
        Size = UDim2.new(1, 0, 1, 0),
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 2) })
    })

    notifFrame.Position = UDim2.new(1, 50, 0, 0)
    Utility.Tween(notifFrame, { Position = UDim2.new(0, 0, 0, 0) }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

    if self.SoundsEnabled then
        Utility.AddSound("rbxassetid://6026984224", 0.3)
    end

    Utility.Tween(progressBar, { Size = UDim2.new(0, 0, 1, 0) }, duration, Enum.EasingStyle.Linear)

    task.delay(duration, function()
        if notifFrame and notifFrame.Parent then
            local dismissTween = Utility.Tween(notifFrame, {
                Position = UDim2.new(1, 50, 0, 0),
                BackgroundTransparency = 1
            }, 0.3)
            dismissTween.Completed:Connect(function()
                if notifFrame then
                    notifFrame:Destroy()
                end
            end)
        end
    end)
end

function KyuuLibrary:SetAccentColor(color)
    self.AccentColor = color
    for _, window in ipairs(self.Windows) do
        if window._updateAccent then
            window:_updateAccent(color)
        end
    end
end

local ActiveContextMenu = nil

local function CreateContextMenu(parent, items, theme)
    if ActiveContextMenu then
        ActiveContextMenu:Destroy()
        ActiveContextMenu = nil
    end

    local mousePos = UserInputService:GetMouseLocation()

    local menu = Utility.Create("Frame", {
        Parent = parent,
        Name = "ContextMenu",
        BackgroundColor3 = theme.SecondaryBackground,
        Position = UDim2.new(0, mousePos.X, 0, mousePos.Y - 36),
        Size = UDim2.new(0, 160, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
        ZIndex = 9999,
        ClipsDescendants = true,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
        Utility.Create("UIStroke", { Color = theme.Border, Thickness = 1, Transparency = 0.5 }),
        Utility.Create("UIPadding", {
            PaddingTop = UDim.new(0, 4),
            PaddingBottom = UDim.new(0, 4),
            PaddingLeft = UDim.new(0, 4),
            PaddingRight = UDim.new(0, 4),
        }),
        Utility.Create("UIListLayout", {
            Padding = UDim.new(0, 2),
            SortOrder = Enum.SortOrder.LayoutOrder,
        }),
    })

    for i, item in ipairs(items) do
        local btn = Utility.Create("TextButton", {
            Parent = menu,
            Name = "ContextItem_" .. i,
            BackgroundColor3 = theme.TertiaryBackground,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 30),
            Text = item.Name,
            TextColor3 = theme.Text,
            TextSize = 13,
            Font = Enum.Font.Gotham,
            TextXAlignment = Enum.TextXAlignment.Left,
            ZIndex = 10000,
            LayoutOrder = i,
        }, {
            Utility.Create("UICorner", { CornerRadius = UDim.new(0, 6) }),
            Utility.Create("UIPadding", { PaddingLeft = UDim.new(0, 10) }),
        })

        btn.MouseEnter:Connect(function()
            Utility.Tween(btn, { BackgroundTransparency = 0.3 }, 0.15)
        end)
        btn.MouseLeave:Connect(function()
            Utility.Tween(btn, { BackgroundTransparency = 1 }, 0.15)
        end)
        btn.MouseButton1Click:Connect(function()
            if item.Callback then
                item.Callback()
            end
            if menu and menu.Parent then
                menu:Destroy()
            end
            ActiveContextMenu = nil
        end)
    end

    menu.BackgroundTransparency = 1
    Utility.Tween(menu, { BackgroundTransparency = 0.02 }, 0.2)

    ActiveContextMenu = menu

    local closeConn
    closeConn = UserInputService.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            task.defer(function()
                if ActiveContextMenu and ActiveContextMenu == menu then
                    local mPos = UserInputService:GetMouseLocation()
                    local absPos = menu.AbsolutePosition
                    local absSize = menu.AbsoluteSize
                    if mPos.X < absPos.X or mPos.X > absPos.X + absSize.X or
                       mPos.Y - 36 < absPos.Y or mPos.Y - 36 > absPos.Y + absSize.Y then
                        menu:Destroy()
                        ActiveContextMenu = nil
                        if closeConn then closeConn:Disconnect() end
                    end
                end
            end)
        end
    end)

    return menu
end

local function ApplyGlow(frame, glowColor, intensity)
    local glow = Utility.Create("ImageLabel", {
        Parent = frame,
        Name = "GlowEffect",
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(1, 60, 1, 60),
        AnchorPoint = Vector2.new(0.5, 0.5),
        Image = "rbxassetid://6014261993",
        ImageColor3 = glowColor or Color3.fromRGB(120, 80, 255),
        ImageTransparency = intensity or 0.6,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(49, 49, 450, 450),
        ZIndex = frame.ZIndex - 1,
    })
    return glow
end

local function ApplyGlassEffect(frame, theme)
    frame.BackgroundTransparency = 0.6
    local glassOverlay = Utility.Create("Frame", {
        Parent = frame,
        Name = "GlassOverlay",
        BackgroundColor3 = Color3.fromRGB(255, 255, 255),
        BackgroundTransparency = 0.92,
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = frame.ZIndex + 1,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 12) }),
        Utility.Create("UIGradient", {
            Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
                ColorSequenceKeypoint.new(0.3, Color3.fromRGB(200, 220, 255)),
                ColorSequenceKeypoint.new(0.7, Color3.fromRGB(180, 200, 240)),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 255, 255)),
            }),
            Transparency = NumberSequence.new({
                NumberSequenceKeypoint.new(0, 0.85),
                NumberSequenceKeypoint.new(0.5, 0.95),
                NumberSequenceKeypoint.new(1, 0.88),
            }),
            Rotation = 25,
        })
    })
    return glassOverlay
end

local function CreateRibbon(parent, color)
    local ribbonWidth = 120
    local ribbonHeight = 35

    local ribbonContainer = Utility.Create("Frame", {
        Parent = parent,
        Name = "RibbonContainer",
        BackgroundTransparency = 1,
        Size = UDim2.new(0, ribbonWidth, 0, ribbonHeight + 12),
        Position = UDim2.new(0.5, 0, 0, -6),
        AnchorPoint = Vector2.new(0.5, 0),
        ZIndex = 20,
        ClipsDescendants = false,
    })

    local ribbonMain = Utility.Create("Frame", {
        Parent = ribbonContainer,
        Name = "RibbonMain",
        BackgroundColor3 = color,
        Size = UDim2.new(1, 0, 0, ribbonHeight),
        Position = UDim2.new(0, 0, 0, 0),
        ZIndex = 21,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 4) }),
        Utility.Create("UIGradient", {
            Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
                ColorSequenceKeypoint.new(0.5, color),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 255, 255)),
            }),
            Transparency = NumberSequence.new({
                NumberSequenceKeypoint.new(0, 0.3),
                NumberSequenceKeypoint.new(0.5, 0),
                NumberSequenceKeypoint.new(1, 0.3),
            }),
        })
    })

    Utility.Create("TextLabel", {
        Parent = ribbonMain,
        Name = "RibbonText",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = "üéÑ",
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 18,
        Font = Enum.Font.GothamBold,
        ZIndex = 22,
    })

    local leftTail = Utility.Create("Frame", {
        Parent = ribbonContainer,
        Name = "LeftTail",
        BackgroundColor3 = Color3.fromRGB(
            math.max(0, color.R * 255 - 40) / 255,
            math.max(0, color.G * 255 - 40) / 255,
            math.max(0, color.B * 255 - 40) / 255
        ),
        Size = UDim2.new(0, 14, 0, 12),
        Position = UDim2.new(0, -4, 1, -4),
        Rotation = 0,
        ZIndex = 19,
    })

    local rightTail = Utility.Create("Frame", {
        Parent = ribbonContainer,
        Name = "RightTail",
        BackgroundColor3 = Color3.fromRGB(
            math.max(0, color.R * 255 - 40) / 255,
            math.max(0, color.G * 255 - 40) / 255,
            math.max(0, color.B * 255 - 40) / 255
        ),
        Size = UDim2.new(0, 14, 0, 12),
        Position = UDim2.new(1, -10, 1, -4),
        Rotation = 0,
        ZIndex = 19,
    })

    return ribbonContainer
end

function KyuuLibrary:CreateWindow(config)
    self:Init()

    local windowTitle = config.Title or "KyuuLibrary Window"
    local subTitle = config.SubTitle or ""
    local windowIcon = config.Icon or ""
    local windowSize = config.Size or UDim2.new(0, 620, 0, 460)
    local themeName = config.Theme or "Dark"
    local acrylicEnabled = config.Acrylic ~= false
    local minimizeKey = config.MinimizeKey or Enum.KeyCode.RightShift
    local saveConfig = config.SaveConfig or false
    local configFolder = config.ConfigFolder or "KyuuLibrary"
    local configName = config.ConfigName or "config.json"

    local Window = {}
    Window._connections = {}
    Window._tabs = {}
    Window._activeTab = nil
    Window._visible = true
    Window._minimized = false
    Window._theme = Themes[themeName] or Themes.Dark
    Window._themeName = themeName
    Window._saveConfig = saveConfig
    Window._configFolder = configFolder
    Window._configName = configName
    Window._configValues = {}
    Window._accentElements = {}
    Window._destroyed = false
    Window._customFeatures = {}

    local theme = Window._theme

    if saveConfig then
        makeFolderCompat(configFolder)
    end

    local mainFrame = Utility.Create("Frame", {
        Parent = self.ScreenGui,
        Name = "KyuuWindow",
        BackgroundColor3 = theme.Background,
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = windowSize,
        AnchorPoint = Vector2.new(0.5, 0.5),
        ClipsDescendants = true,
        BackgroundTransparency = theme.GlassEnabled and 0.4 or 0,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 12) }),
    })
    Window._mainFrame = mainFrame

    Utility.Create("UIStroke", {
        Parent = mainFrame,
        Color = theme.GlassEnabled and Color3.fromRGB(255, 255, 255) or theme.Border,
        Thickness = theme.GlassEnabled and 1.5 or 1,
        Transparency = theme.GlassEnabled and 0.3 or 0.3,
    })

    local shadowFrame = Utility.Create("ImageLabel", {
        Parent = mainFrame,
        Name = "Shadow",
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(1, 40, 1, 40),
        AnchorPoint = Vector2.new(0.5, 0.5),
        Image = "rbxassetid://6014261993",
        ImageColor3 = Color3.fromRGB(0, 0, 0),
        ImageTransparency = 0.5,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(49, 49, 450, 450),
        ZIndex = -1,
    })

    if theme.GlowEnabled then
        ApplyGlow(mainFrame, theme.Accent, 0.65)
    end

    if theme.GlassEnabled then
        ApplyGlassEffect(mainFrame, theme)
    end

    if acrylicEnabled and not theme.GlassEnabled then
        Utility.Create("Frame", {
            Parent = mainFrame,
            Name = "AcrylicOverlay",
            BackgroundColor3 = theme.Background,
            BackgroundTransparency = 0.15,
            Size = UDim2.new(1, 0, 1, 0),
            ZIndex = 0,
        }, {
            Utility.Create("UICorner", { CornerRadius = UDim.new(0, 12) }),
            Utility.Create("UIGradient", {
                Color = ColorSequence.new({
                    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
                    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(200, 200, 220)),
                    ColorSequenceKeypoint.new(1, Color3.fromRGB(180, 180, 200)),
                }),
                Transparency = NumberSequence.new({
                    NumberSequenceKeypoint.new(0, 0.92),
                    NumberSequenceKeypoint.new(0.5, 0.96),
                    NumberSequenceKeypoint.new(1, 0.88),
                }),
                Rotation = 35,
            })
        })
    end

    local titleBarHeight = 48
    local titleBar = Utility.Create("Frame", {
        Parent = mainFrame,
        Name = "TitleBar",
        BackgroundColor3 = theme.SecondaryBackground,
        BackgroundTransparency = theme.GlassEnabled and 0.5 or 0.2,
        Size = UDim2.new(1, 0, 0, titleBarHeight),
        ZIndex = 5,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 12) }),
    })

    Utility.Create("Frame", {
        Parent = titleBar,
        Name = "BottomFill",
        BackgroundColor3 = theme.SecondaryBackground,
        BackgroundTransparency = theme.GlassEnabled and 0.5 or 0.2,
        Size = UDim2.new(1, 0, 0, 14),
        Position = UDim2.new(0, 0, 1, -14),
        ZIndex = 5,
        BorderSizePixel = 0,
    })

    Utility.Create("Frame", {
        Parent = titleBar,
        Name = "Separator",
        BackgroundColor3 = theme.Border,
        BackgroundTransparency = 0.5,
        Size = UDim2.new(1, 0, 0, 1),
        Position = UDim2.new(0, 0, 1, -1),
        ZIndex = 6,
        BorderSizePixel = 0,
    })

    if theme.RibbonEnabled then
        CreateRibbon(titleBar, theme.RibbonColor)
    end

    local titleOffset = 14
    if windowIcon ~= "" then
        Utility.Create("ImageLabel", {
            Parent = titleBar,
            Name = "Icon",
            BackgroundTransparency = 1,
            Size = UDim2.new(0, 22, 0, 22),
            Position = UDim2.new(0, 14, 0.5, 0),
            AnchorPoint = Vector2.new(0, 0.5),
            Image = windowIcon,
            ZIndex = 6,
        })
        titleOffset = 44
    end

    local titleLabel = Utility.Create("TextLabel", {
        Parent = titleBar,
        Name = "TitleLabel",
        BackgroundTransparency = 1,
        Size = UDim2.new(0.6, 0, 1, 0),
        Position = UDim2.new(0, titleOffset, 0, 0),
        Text = windowTitle,
        TextColor3 = theme.Text,
        TextSize = 16,
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 6,
    })

    if subTitle ~= "" then
        titleLabel.Size = UDim2.new(0.6, 0, 0, 22)
        titleLabel.Position = UDim2.new(0, titleOffset, 0, 6)
        titleLabel.TextSize = 14

        Utility.Create("TextLabel", {
            Parent = titleBar,
            Name = "SubTitleLabel",
            BackgroundTransparency = 1,
            Size = UDim2.new(0.6, 0, 0, 16),
            Position = UDim2.new(0, titleOffset, 0, 26),
            Text = subTitle,
            TextColor3 = theme.TextDimmed,
            TextSize = 11,
            Font = Enum.Font.Gotham,
            TextXAlignment = Enum.TextXAlignment.Left,
            ZIndex = 6,
        })
    end

    local closeBtn = Utility.Create("TextButton", {
        Parent = titleBar,
        Name = "CloseBtn",
        BackgroundColor3 = theme.Error,
        BackgroundTransparency = 0.8,
        Size = UDim2.new(0, 28, 0, 28),
        Position = UDim2.new(1, -42, 0.5, 0),
        AnchorPoint = Vector2.new(0, 0.5),
        Text = "‚úï",
        TextColor3 = theme.Text,
        TextSize = 14,
        Font = Enum.Font.GothamBold,
        ZIndex = 7,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) })
    })

    local minimizeBtn = Utility.Create("TextButton", {
        Parent = titleBar,
        Name = "MinimizeBtn",
        BackgroundColor3 = theme.Warning,
        BackgroundTransparency = 0.8,
        Size = UDim2.new(0, 28, 0, 28),
        Position = UDim2.new(1, -76, 0.5, 0),
        AnchorPoint = Vector2.new(0, 0.5),
        Text = "‚Äî",
        TextColor3 = theme.Text,
        TextSize = 14,
        Font = Enum.Font.GothamBold,
        ZIndex = 7,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) })
    })

    for _, btn in ipairs({closeBtn, minimizeBtn}) do
        btn.MouseEnter:Connect(function()
            Utility.Tween(btn, { BackgroundTransparency = 0.3 }, 0.15)
        end)
        btn.MouseLeave:Connect(function()
            Utility.Tween(btn, { BackgroundTransparency = 0.8 }, 0.15)
        end)
    end

    local dragConnections = Utility.MakeDraggable(titleBar, mainFrame)
    for _, c in ipairs(dragConnections) do
        table.insert(Window._connections, c)
    end

    local sidebarWidth = 170
    local sidebar = Utility.Create("Frame", {
        Parent = mainFrame,
        Name = "Sidebar",
        BackgroundColor3 = theme.Sidebar,
        BackgroundTransparency = theme.GlassEnabled and 0.4 or 0,
        Size = UDim2.new(0, sidebarWidth, 1, -titleBarHeight),
        Position = UDim2.new(0, 0, 0, titleBarHeight),
        ZIndex = 3,
        BorderSizePixel = 0,
    })

    Utility.Create("Frame", {
        Parent = sidebar,
        Name = "Border",
        BackgroundColor3 = theme.Border,
        BackgroundTransparency = 0.5,
        Size = UDim2.new(0, 1, 1, 0),
        Position = UDim2.new(1, -1, 0, 0),
        ZIndex = 4,
        BorderSizePixel = 0,
    })

    local searchContainer = Utility.Create("Frame", {
        Parent = sidebar,
        Name = "SearchContainer",
        BackgroundColor3 = theme.InputBackground,
        Size = UDim2.new(1, -20, 0, 32),
        Position = UDim2.new(0, 10, 0, 10),
        ZIndex = 4,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
        Utility.Create("UIStroke", { Color = theme.ElementStrokeColor, Thickness = 1, Transparency = theme.ElementStrokeTransparency }),
    })

    Utility.Create("TextLabel", {
        Parent = searchContainer,
        Name = "SearchIcon",
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 28, 1, 0),
        Text = "üîç",
        TextColor3 = theme.TextDimmed,
        TextSize = 13,
        Font = Enum.Font.Gotham,
        ZIndex = 5,
    })

    local searchBox = Utility.Create("TextBox", {
        Parent = searchContainer,
        Name = "SearchBox",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -34, 1, 0),
        Position = UDim2.new(0, 30, 0, 0),
        Text = "",
        PlaceholderText = "Search tabs...",
        PlaceholderColor3 = theme.TextDimmed,
        TextColor3 = theme.Text,
        TextSize = 13,
        Font = Enum.Font.Gotham,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        ZIndex = 5,
    })

    local tabListScroll = Utility.Create("ScrollingFrame", {
        Parent = sidebar,
        Name = "TabList",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -10, 1, -56),
        Position = UDim2.new(0, 5, 0, 50),
        ScrollBarThickness = 2,
        ScrollBarImageColor3 = theme.Accent,
        ScrollBarImageTransparency = 0.5,
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ZIndex = 4,
        BorderSizePixel = 0,
    }, {
        Utility.Create("UIListLayout", {
            Padding = UDim.new(0, 4),
            SortOrder = Enum.SortOrder.LayoutOrder,
        }),
        Utility.Create("UIPadding", {
            PaddingTop = UDim.new(0, 2),
            PaddingBottom = UDim.new(0, 8),
        })
    })

    searchBox:GetPropertyChangedSignal("Text"):Connect(function()
        local query = string.lower(searchBox.Text)
        for _, tabData in ipairs(Window._tabs) do
            if query == "" then
                tabData._button.Visible = true
            else
                tabData._button.Visible = string.find(string.lower(tabData._name), query, 1, true) ~= nil
            end
        end
    end)

    local contentArea = Utility.Create("Frame", {
        Parent = mainFrame,
        Name = "ContentArea",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -sidebarWidth, 1, -titleBarHeight),
        Position = UDim2.new(0, sidebarWidth, 0, titleBarHeight),
        ZIndex = 2,
        ClipsDescendants = true,
    })

    local resizeHandle = Utility.Create("TextButton", {
        Parent = mainFrame,
        Name = "ResizeHandle",
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 20, 0, 20),
        Position = UDim2.new(1, -20, 1, -20),
        Text = "‚ã±",
        TextColor3 = theme.TextDimmed,
        TextSize = 16,
        Font = Enum.Font.GothamBold,
        ZIndex = 10,
    })

    do
        local resizing = false
        local startMousePos
        local startSize

        table.insert(Window._connections, resizeHandle.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                resizing = true
                startMousePos = input.Position
                startSize = mainFrame.Size
            end
        end))

        table.insert(Window._connections, UserInputService.InputChanged:Connect(function(input)
            if resizing and (input.UserInputType == Enum.UserInputType.MouseMovement) then
                local delta = input.Position - startMousePos
                local newWidth = math.max(500, startSize.X.Offset + delta.X)
                local newHeight = math.max(350, startSize.Y.Offset + delta.Y)
                mainFrame.Size = UDim2.new(0, newWidth, 0, newHeight)
            end
        end))

        table.insert(Window._connections, UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                resizing = false
            end
        end))
    end

    local watermark = Utility.Create("Frame", {
        Parent = self.ScreenGui,
        Name = "Watermark",
        BackgroundColor3 = theme.SecondaryBackground,
        BackgroundTransparency = 0.1,
        Size = UDim2.new(0, 280, 0, 28),
        Position = UDim2.new(0, 12, 0, 12),
        ZIndex = 9000,
    }, {
        Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
        Utility.Create("UIStroke", { Color = theme.Border, Thickness = 1, Transparency = 0.5 }),
    })
    Window._watermark = watermark

    local watermarkLabel = Utility.Create("TextLabel", {
        Parent = watermark,
        Name = "Text",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -16, 1, 0),
        Position = UDim2.new(0, 8, 0, 0),
        Text = "",
        TextColor3 = theme.Text,
        TextSize = 12,
        Font = Enum.Font.GothamMedium,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 9001,
    })

    local fps = 60
    local fpsUpdateConn = RunService.Heartbeat:Connect(function(dt)
        fps = math.floor(1 / dt)
    end)
    table.insert(Window._connections, fpsUpdateConn)

    task.spawn(function()
        while not Window._destroyed do
            local playerName = LocalPlayer and LocalPlayer.Name or "Unknown"
            watermarkLabel.Text = string.format("KyuuLibrary | %s | %d FPS | %s",
                windowTitle, fps, playerName)
            task.wait(0.5)
        end
    end)

    mainFrame.Size = UDim2.new(0, 0, 0, 0)
    mainFrame.BackgroundTransparency = 1
    Utility.Tween(mainFrame, {
        Size = windowSize,
        BackgroundTransparency = theme.GlassEnabled and 0.4 or 0,
    }, 0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

    table.insert(Window._connections, UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        if input.KeyCode == minimizeKey then
            Window:Minimize()
        end
    end))

    closeBtn.MouseButton1Click:Connect(function()
        Window:Destroy()
    end)

    minimizeBtn.MouseButton1Click:Connect(function()
        Window:Minimize()
    end)

    function Window:Toggle()
        self._visible = not self._visible
        if self._visible then
            mainFrame.Visible = true
            watermark.Visible = true
            Utility.Tween(mainFrame, {
                Size = windowSize,
                BackgroundTransparency = theme.GlassEnabled and 0.4 or 0,
            }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        else
            local tween = Utility.Tween(mainFrame, {
                Size = UDim2.new(0, windowSize.X.Offset * 0.95, 0, windowSize.Y.Offset * 0.95),
                BackgroundTransparency = 1,
            }, 0.25)
            tween.Completed:Connect(function()
                if not self._visible then
                    mainFrame.Visible = false
                    watermark.Visible = false
                end
            end)
        end
    end

    function Window:Minimize()
        self._minimized = not self._minimized
        if self._minimized then
            Utility.Tween(mainFrame, {
                Size = UDim2.new(0, windowSize.X.Offset, 0, titleBarHeight),
            }, 0.3, Enum.EasingStyle.Sine)
            contentArea.Visible = false
            sidebar.Visible = false
        else
            contentArea.Visible = true
            sidebar.Visible = true
            Utility.Tween(mainFrame, {
                Size = windowSize,
            }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        end
    end

    function Window:Destroy()
        self._destroyed = true
        for _, conn in ipairs(self._connections) do
            if typeof(conn) == "RBXScriptConnection" then
                conn:Disconnect()
            end
        end
        self._connections = {}

        if self._saveConfig then
            self:SaveConfig()
        end

        local tween = Utility.Tween(mainFrame, {
            Size = UDim2.new(0, 0, 0, 0),
            BackgroundTransparency = 1,
        }, 0.3)
        tween.Completed:Connect(function()
            if mainFrame then mainFrame:Destroy() end
            if watermark then watermark:Destroy() end
        end)

        for i, w in ipairs(KyuuLibrary.Windows) do
            if w == self then
                table.remove(KyuuLibrary.Windows, i)
                break
            end
        end
    end

    function Window:SetTheme(newThemeName)
        local newTheme = Themes[newThemeName]
        if not newTheme then return end
        self._theme = newTheme
        self._themeName = newThemeName

        mainFrame.BackgroundColor3 = newTheme.Background
        mainFrame.BackgroundTransparency = newTheme.GlassEnabled and 0.4 or 0
        titleBar.BackgroundColor3 = newTheme.SecondaryBackground
        titleBar.BackgroundTransparency = newTheme.GlassEnabled and 0.5 or 0.2
        sidebar.BackgroundColor3 = newTheme.Sidebar
        sidebar.BackgroundTransparency = newTheme.GlassEnabled and 0.4 or 0
        titleLabel.TextColor3 = newTheme.Text
        searchBox.TextColor3 = newTheme.Text
        searchBox.PlaceholderColor3 = newTheme.TextDimmed
        searchContainer.BackgroundColor3 = newTheme.InputBackground
        watermark.BackgroundColor3 = newTheme.SecondaryBackground
        watermarkLabel.TextColor3 = newTheme.Text

        local bottomFill = titleBar:FindFirstChild("BottomFill")
        if bottomFill then
            bottomFill.BackgroundColor3 = newTheme.SecondaryBackground
            bottomFill.BackgroundTransparency = newTheme.GlassEnabled and 0.5 or 0.2
        end

        local mainStroke = mainFrame:FindFirstChildOfClass("UIStroke")
        if mainStroke then
            mainStroke.Color = newTheme.GlassEnabled and Color3.fromRGB(255, 255, 255) or newTheme.Border
            mainStroke.Thickness = newTheme.GlassEnabled and 1.5 or 1
        end

        local oldGlow = mainFrame:FindFirstChild("GlowEffect")
        if oldGlow then oldGlow:Destroy() end
        local oldGlass = mainFrame:FindFirstChild("GlassOverlay")
        if oldGlass then oldGlass:Destroy() end
        local oldRibbon = titleBar:FindFirstChild("RibbonContainer")
        if oldRibbon then oldRibbon:Destroy() end

        if newTheme.GlowEnabled then
            ApplyGlow(mainFrame, newTheme.Accent, 0.65)
        end
        if newTheme.GlassEnabled then
            ApplyGlassEffect(mainFrame, newTheme)
        end
        if newTheme.RibbonEnabled then
            CreateRibbon(titleBar, newTheme.RibbonColor)
        end
    end

    function Window:_updateAccent(color)
        for _, element in ipairs(self._accentElements) do
            if element and element.Parent then
                pcall(function()
                    element.BackgroundColor3 = color
                end)
            end
        end
    end

    function Window:AddCustomFeature(featureConfig)
        local featureName = featureConfig.Name or "Custom Feature"
        local featureKey = featureConfig.Key or nil
        local featureCallback = featureConfig.Callback or function() end
        local featureToggle = featureConfig.Toggle or false
        local featureState = featureConfig.Default or false

        local feature = {
            Name = featureName,
            Key = featureKey,
            Callback = featureCallback,
            IsToggle = featureToggle,
            State = featureState,
        }

        if featureKey then
            table.insert(self._connections, UserInputService.InputBegan:Connect(function(input, processed)
                if processed then return end
                if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == featureKey then
                    if feature.IsToggle then
                        feature.State = not feature.State
                        featureCallback(feature.State)
                    else
                        featureCallback()
                    end
                end
            end))
        end

        table.insert(self._customFeatures, feature)
        return feature
    end

    function Window:SaveConfig()
        if not self._saveConfig then return end
        local data = {}
        for key, valueFunc in pairs(self._configValues) do
            local success, val = pcall(valueFunc)
            if success then
                if typeof(val) == "Color3" then
                    data[key] = { R = val.R, G = val.G, B = val.B, _type = "Color3" }
                elseif typeof(val) == "EnumItem" then
                    data[key] = { _type = "EnumItem", _enum = tostring(val.EnumType), _value = val.Name }
                elseif type(val) == "table" then
                    data[key] = { _type = "table", _value = val }
                else
                    data[key] = val
                end
            end
        end
        local jsonString = HttpService:JSONEncode(data)
        writefileCompat(self._configFolder .. "/" .. self._configName, jsonString)
    end

    function Window:LoadConfig()
        if not self._saveConfig then return end
        local path = self._configFolder .. "/" .. self._configName
        if not isfileCompat(path) then return end

        local jsonString = readfileCompat(path)
        if not jsonString then return end

        local success, data = pcall(function()
            return HttpService:JSONDecode(jsonString)
        end)
        if not success or type(data) ~= "table" then return end

        return data
    end

    function Window:CreateTab(name, icon)
        local tabData = {}
        tabData._name = name
        tabData._sections = {}
        tabData._layoutOrder = #self._tabs + 1

        local tabButton = Utility.Create("TextButton", {
            Parent = tabListScroll,
            Name = "Tab_" .. name,
            BackgroundColor3 = theme.TertiaryBackground,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, -10, 0, 36),
            Text = "",
            ZIndex = 5,
            LayoutOrder = tabData._layoutOrder,
        }, {
            Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
        })
        tabData._button = tabButton

        local textOffset = 12
        if icon and icon ~= "" then
            Utility.Create("ImageLabel", {
                Parent = tabButton,
                Name = "Icon",
                BackgroundTransparency = 1,
                Size = UDim2.new(0, 18, 0, 18),
                Position = UDim2.new(0, 10, 0.5, 0),
                AnchorPoint = Vector2.new(0, 0.5),
                Image = icon,
                ImageColor3 = theme.TextDark,
                ZIndex = 6,
            })
            textOffset = 34
        end

        local tabLabel = Utility.Create("TextLabel", {
            Parent = tabButton,
            Name = "Label",
            BackgroundTransparency = 1,
            Size = UDim2.new(1, -textOffset - 8, 1, 0),
            Position = UDim2.new(0, textOffset, 0, 0),
            Text = name,
            TextColor3 = theme.TextDark,
            TextSize = 13,
            Font = Enum.Font.GothamMedium,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd,
            ZIndex = 6,
        })

        local activeIndicator = Utility.Create("Frame", {
            Parent = tabButton,
            Name = "ActiveIndicator",
            BackgroundColor3 = theme.Accent,
            Size = UDim2.new(0, 3, 0, 0),
            Position = UDim2.new(0, 0, 0.5, 0),
            AnchorPoint = Vector2.new(0, 0.5),
            ZIndex = 7,
        }, {
            Utility.Create("UICorner", { CornerRadius = UDim.new(0, 2) })
        })
        table.insert(self._accentElements, activeIndicator)

        local tabContent = Utility.Create("ScrollingFrame", {
            Parent = contentArea,
            Name = "TabContent_" .. name,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            ScrollBarThickness = 3,
            ScrollBarImageColor3 = theme.Accent,
            ScrollBarImageTransparency = 0.4,
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            Visible = false,
            ZIndex = 3,
            BorderSizePixel = 0,
        }, {
            Utility.Create("UIListLayout", {
                Padding = UDim.new(0, 10),
                SortOrder = Enum.SortOrder.LayoutOrder,
                HorizontalAlignment = Enum.HorizontalAlignment.Center,
            }),
            Utility.Create("UIPadding", {
                PaddingTop = UDim.new(0, 12),
                PaddingBottom = UDim.new(0, 12),
                PaddingLeft = UDim.new(0, 12),
                PaddingRight = UDim.new(0, 12),
            })
        })
        tabData._content = tabContent

        local function activateTab()
            for _, otherTab in ipairs(self._tabs) do
                otherTab._content.Visible = false
                Utility.Tween(otherTab._button, { BackgroundTransparency = 1 }, 0.2)
                local otherLabel = otherTab._button:FindFirstChild("Label")
                if otherLabel then
                    Utility.Tween(otherLabel, { TextColor3 = theme.TextDark }, 0.2)
                end
                local otherIcon = otherTab._button:FindFirstChild("Icon")
                if otherIcon then
                    Utility.Tween(otherIcon, { ImageColor3 = theme.TextDark }, 0.2)
                end
                local otherIndicator = otherTab._button:FindFirstChild("ActiveIndicator")
                if otherIndicator then
                    Utility.Tween(otherIndicator, { Size = UDim2.new(0, 3, 0, 0) }, 0.2)
                end
            end

            tabContent.Visible = true
            Utility.Tween(tabButton, { BackgroundTransparency = 0.6 }, 0.2)
            Utility.Tween(tabLabel, { TextColor3 = theme.Text }, 0.2)
            Utility.Tween(activeIndicator, { Size = UDim2.new(0, 3, 0, 20) }, 0.25, Enum.EasingStyle.Back)

            local tabIcon = tabButton:FindFirstChild("Icon")
            if tabIcon then
                Utility.Tween(tabIcon, { ImageColor3 = theme.Accent }, 0.2)
            end

            self._activeTab = tabData

            if KyuuLibrary.SoundsEnabled then
                Utility.AddSound("rbxassetid://6026984224", 0.15)
            end
        end

        tabButton.MouseButton1Click:Connect(activateTab)

        tabButton.MouseEnter:Connect(function()
            if self._activeTab ~= tabData then
                Utility.Tween(tabButton, { BackgroundTransparency = 0.75 }, 0.15)
            end
        end)
        tabButton.MouseLeave:Connect(function()
            if self._activeTab ~= tabData then
                Utility.Tween(tabButton, { BackgroundTransparency = 1 }, 0.15)
            end
        end)

        if #self._tabs == 0 then
            task.defer(activateTab)
        end

        function tabData:CreateSection(sectionName)
            local section = {}
            section._elements = {}
            section._layoutOrder = #tabData._sections + 1

            local sectionFrame = Utility.Create("Frame", {
                Parent = tabContent,
                Name = "Section_" .. sectionName,
                BackgroundColor3 = theme.SecondaryBackground,
                BackgroundTransparency = theme.ElementTransparency - 0.2,
                Size = UDim2.new(1, 0, 0, 0),
                AutomaticSize = Enum.AutomaticSize.Y,
                LayoutOrder = section._layoutOrder,
                ZIndex = 3,
            }, {
                Utility.Create("UICorner", { CornerRadius = UDim.new(0, 10) }),
                Utility.Create("UIStroke", { Color = theme.ElementStrokeColor, Thickness = 1, Transparency = theme.ElementStrokeTransparency }),
                Utility.Create("UIPadding", {
                    PaddingTop = UDim.new(0, 32),
                    PaddingBottom = UDim.new(0, 10),
                    PaddingLeft = UDim.new(0, 12),
                    PaddingRight = UDim.new(0, 12),
                }),
                Utility.Create("UIListLayout", {
                    Padding = UDim.new(0, 6),
                    SortOrder = Enum.SortOrder.LayoutOrder,
                }),
            })
            section._frame = sectionFrame

            Utility.Create("TextLabel", {
                Parent = sectionFrame,
                Name = "Header",
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 18),
                Position = UDim2.new(0, 0, 0, -28),
                Text = sectionName,
                TextColor3 = theme.Accent,
                TextSize = 12,
                Font = Enum.Font.GothamBold,
                TextXAlignment = Enum.TextXAlignment.Left,
                LayoutOrder = 0,
                ZIndex = 4,
            })

            function section:CreateToggle(cfg)
                local toggleName = cfg.Name or "Toggle"
                local default = cfg.Default or false
                local callback = cfg.Callback or function() end
                local flag = cfg.Flag or toggleName
                local toggled = default

                local toggleFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Toggle_" .. toggleName,
                    BackgroundColor3 = theme.TertiaryBackground,
                    BackgroundTransparency = theme.ElementTransparency,
                    Size = UDim2.new(1, 0, 0, 38),
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                    Utility.Create("UIStroke", {
                        Color = theme.GlassEnabled and Color3.fromRGB(255, 255, 255) or theme.ElementStrokeColor,
                        Thickness = theme.GlassEnabled and 1 or 0,
                        Transparency = theme.GlassEnabled and 0.5 or 1,
                    }),
                })

                Utility.Create("TextLabel", {
                    Parent = toggleFrame,
                    Name = "Label",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, -60, 1, 0),
                    Position = UDim2.new(0, 12, 0, 0),
                    Text = toggleName,
                    TextColor3 = theme.Text,
                    TextSize = 14,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 5,
                })

                local toggleBg = Utility.Create("Frame", {
                    Parent = toggleFrame,
                    Name = "ToggleBg",
                    BackgroundColor3 = toggled and theme.ToggleOn or theme.ToggleOff,
                    Size = UDim2.new(0, 42, 0, 22),
                    Position = UDim2.new(1, -54, 0.5, 0),
                    AnchorPoint = Vector2.new(0, 0.5),
                    ZIndex = 5,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(1, 0) }),
                })
                table.insert(Window._accentElements, toggleBg)

                local toggleCircle = Utility.Create("Frame", {
                    Parent = toggleBg,
                    Name = "Circle",
                    BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                    Size = UDim2.new(0, 16, 0, 16),
                    Position = toggled and UDim2.new(1, -19, 0.5, 0) or UDim2.new(0, 3, 0.5, 0),
                    AnchorPoint = Vector2.new(0, 0.5),
                    ZIndex = 6,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(1, 0) }),
                })

                local toggleButton = Utility.Create("TextButton", {
                    Parent = toggleFrame,
                    Name = "ClickArea",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 1, 0),
                    Text = "",
                    ZIndex = 7,
                })

                local function updateVisual()
                    Utility.Tween(toggleBg, {
                        BackgroundColor3 = toggled and (KyuuLibrary.AccentColor or theme.ToggleOn) or theme.ToggleOff
                    }, 0.2)
                    Utility.Tween(toggleCircle, {
                        Position = toggled and UDim2.new(1, -19, 0.5, 0) or UDim2.new(0, 3, 0.5, 0)
                    }, 0.2, Enum.EasingStyle.Back)
                end

                toggleButton.MouseButton1Click:Connect(function()
                    toggled = not toggled
                    updateVisual()
                    callback(toggled)
                    if KyuuLibrary.SoundsEnabled then
                        Utility.AddSound("rbxassetid://6026984224", 0.2)
                    end
                end)

                toggleFrame.MouseEnter:Connect(function()
                    Utility.Tween(toggleFrame, { BackgroundTransparency = theme.ElementTransparency - 0.2 }, 0.15)
                end)
                toggleFrame.MouseLeave:Connect(function()
                    Utility.Tween(toggleFrame, { BackgroundTransparency = theme.ElementTransparency }, 0.15)
                end)

                toggleButton.MouseButton2Click:Connect(function()
                    CreateContextMenu(KyuuLibrary.ScreenGui, {
                        { Name = "Reset to Default", Callback = function()
                            toggled = default
                            updateVisual()
                            callback(toggled)
                        end },
                        { Name = "Copy Value", Callback = function()
                            pcall(function() setclipboard(tostring(toggled)) end)
                        end },
                    }, theme)
                end)

                Window._configValues[flag] = function() return toggled end

                local toggleObj = {}
                function toggleObj:Set(value)
                    toggled = value
                    updateVisual()
                    callback(toggled)
                end
                function toggleObj:Get()
                    return toggled
                end

                table.insert(section._elements, toggleObj)
                return toggleObj
            end

            function section:CreateButton(cfg)
                local btnName = cfg.Name or "Button"
                local callback = cfg.Callback or function() end

                local buttonFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Button_" .. btnName,
                    BackgroundColor3 = theme.TertiaryBackground,
                    BackgroundTransparency = theme.ElementTransparency,
                    Size = UDim2.new(1, 0, 0, 38),
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                    Utility.Create("UIStroke", {
                        Color = theme.GlassEnabled and Color3.fromRGB(255, 255, 255) or theme.ElementStrokeColor,
                        Thickness = theme.GlassEnabled and 1 or 0,
                        Transparency = theme.GlassEnabled and 0.5 or 1,
                    }),
                })

                local btn = Utility.Create("TextButton", {
                    Parent = buttonFrame,
                    Name = "Btn",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 1, 0),
                    Text = btnName,
                    TextColor3 = theme.Text,
                    TextSize = 14,
                    Font = Enum.Font.GothamMedium,
                    ZIndex = 5,
                })

                btn.MouseButton1Click:Connect(function()
                    Utility.Ripple(buttonFrame, theme.Accent)
                    callback()
                    if KyuuLibrary.SoundsEnabled then
                        Utility.AddSound("rbxassetid://6026984224", 0.2)
                    end
                end)

                buttonFrame.MouseEnter:Connect(function()
                    Utility.Tween(buttonFrame, {
                        BackgroundTransparency = theme.ElementTransparency - 0.2,
                        BackgroundColor3 = theme.ButtonHover
                    }, 0.15)
                end)
                buttonFrame.MouseLeave:Connect(function()
                    Utility.Tween(buttonFrame, {
                        BackgroundTransparency = theme.ElementTransparency,
                        BackgroundColor3 = theme.TertiaryBackground
                    }, 0.15)
                end)

                local buttonObj = {}
                function buttonObj:SetText(text)
                    btn.Text = text
                end
                table.insert(section._elements, buttonObj)
                return buttonObj
            end

            function section:CreateSlider(cfg)
                local sliderName = cfg.Name or "Slider"
                local minVal = cfg.Min or 0
                local maxVal = cfg.Max or 100
                local increment = cfg.Increment or 1
                local default = cfg.Default or minVal
                local callback = cfg.Callback or function() end
                local flag = cfg.Flag or sliderName
                local currentValue = default

                local sliderFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Slider_" .. sliderName,
                    BackgroundColor3 = theme.TertiaryBackground,
                    BackgroundTransparency = theme.ElementTransparency,
                    Size = UDim2.new(1, 0, 0, 52),
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                    Utility.Create("UIStroke", {
                        Color = theme.GlassEnabled and Color3.fromRGB(255, 255, 255) or theme.ElementStrokeColor,
                        Thickness = theme.GlassEnabled and 1 or 0,
                        Transparency = theme.GlassEnabled and 0.5 or 1,
                    }),
                })

                Utility.Create("TextLabel", {
                    Parent = sliderFrame,
                    Name = "Label",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, -60, 0, 20),
                    Position = UDim2.new(0, 12, 0, 4),
                    Text = sliderName,
                    TextColor3 = theme.Text,
                    TextSize = 13,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 5,
                })

                local valueLabel = Utility.Create("TextLabel", {
                    Parent = sliderFrame,
                    Name = "Value",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(0, 50, 0, 20),
                    Position = UDim2.new(1, -62, 0, 4),
                    Text = tostring(currentValue),
                    TextColor3 = theme.Accent,
                    TextSize = 13,
                    Font = Enum.Font.GothamBold,
                    TextXAlignment = Enum.TextXAlignment.Right,
                    ZIndex = 5,
                })

                local sliderBg = Utility.Create("Frame", {
                    Parent = sliderFrame,
                    Name = "SliderBg",
                    BackgroundColor3 = theme.SliderBackground,
                    Size = UDim2.new(1, -24, 0, 6),
                    Position = UDim2.new(0, 12, 0, 34),
                    ZIndex = 5,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(1, 0) }),
                })

                local fillPercent = (currentValue - minVal) / (maxVal - minVal)
                local sliderFill = Utility.Create("Frame", {
                    Parent = sliderBg,
                    Name = "Fill",
                    BackgroundColor3 = theme.SliderFill,
                    Size = UDim2.new(fillPercent, 0, 1, 0),
                    ZIndex = 6,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(1, 0) }),
                })
                table.insert(Window._accentElements, sliderFill)

                local sliderKnob = Utility.Create("Frame", {
                    Parent = sliderBg,
                    Name = "Knob",
                    BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                    Size = UDim2.new(0, 14, 0, 14),
                    Position = UDim2.new(fillPercent, 0, 0.5, 0),
                    AnchorPoint = Vector2.new(0.5, 0.5),
                    ZIndex = 7,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(1, 0) }),
                    Utility.Create("UIStroke", { Color = theme.Accent, Thickness = 2 }),
                })

                local sliderInput = Utility.Create("TextButton", {
                    Parent = sliderBg,
                    Name = "InputArea",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 20, 1, 20),
                    Position = UDim2.new(0, -10, 0, -10),
                    Text = "",
                    ZIndex = 8,
                })

                local sliding = false

                local function updateSlider(inputPos)
                    local absPos = sliderBg.AbsolutePosition.X
                    local absSize = sliderBg.AbsoluteSize.X
                    local relative = math.clamp((inputPos - absPos) / absSize, 0, 1)
                    local rawValue = minVal + (maxVal - minVal) * relative
                    local snapped = math.floor(rawValue / increment + 0.5) * increment
                    snapped = math.clamp(snapped, minVal, maxVal)

                    if increment >= 1 then
                        snapped = math.floor(snapped + 0.5)
                    end

                    currentValue = snapped
                    local percent = (currentValue - minVal) / (maxVal - minVal)

                    Utility.Tween(sliderFill, { Size = UDim2.new(percent, 0, 1, 0) }, 0.08)
                    Utility.Tween(sliderKnob, { Position = UDim2.new(percent, 0, 0.5, 0) }, 0.08)
                    valueLabel.Text = tostring(currentValue)
                    callback(currentValue)
                end

                sliderInput.MouseButton1Down:Connect(function()
                    sliding = true
                    updateSlider(Mouse.X)
                end)

                table.insert(Window._connections, UserInputService.InputChanged:Connect(function(input)
                    if sliding and input.UserInputType == Enum.UserInputType.MouseMovement then
                        updateSlider(input.Position.X)
                    end
                end))

                table.insert(Window._connections, UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        sliding = false
                    end
                end))

                sliderFrame.MouseEnter:Connect(function()
                    Utility.Tween(sliderFrame, { BackgroundTransparency = theme.ElementTransparency - 0.2 }, 0.15)
                end)
                sliderFrame.MouseLeave:Connect(function()
                    Utility.Tween(sliderFrame, { BackgroundTransparency = theme.ElementTransparency }, 0.15)
                end)

                sliderInput.MouseButton2Click:Connect(function()
                    CreateContextMenu(KyuuLibrary.ScreenGui, {
                        { Name = "Reset to Default", Callback = function()
                            currentValue = default
                            local pct = (currentValue - minVal) / (maxVal - minVal)
                            Utility.Tween(sliderFill, { Size = UDim2.new(pct, 0, 1, 0) }, 0.2)
                            Utility.Tween(sliderKnob, { Position = UDim2.new(pct, 0, 0.5, 0) }, 0.2)
                            valueLabel.Text = tostring(currentValue)
                            callback(currentValue)
                        end },
                        { Name = "Set to Min", Callback = function()
                            currentValue = minVal
                            Utility.Tween(sliderFill, { Size = UDim2.new(0, 0, 1, 0) }, 0.2)
                            Utility.Tween(sliderKnob, { Position = UDim2.new(0, 0, 0.5, 0) }, 0.2)
                            valueLabel.Text = tostring(currentValue)
                            callback(currentValue)
                        end },
                        { Name = "Set to Max", Callback = function()
                            currentValue = maxVal
                            Utility.Tween(sliderFill, { Size = UDim2.new(1, 0, 1, 0) }, 0.2)
                            Utility.Tween(sliderKnob, { Position = UDim2.new(1, 0, 0.5, 0) }, 0.2)
                            valueLabel.Text = tostring(currentValue)
                            callback(currentValue)
                        end },
                        { Name = "Copy Value", Callback = function()
                            pcall(function() setclipboard(tostring(currentValue)) end)
                        end },
                    }, theme)
                end)

                Window._configValues[flag] = function() return currentValue end

                local sliderObj = {}
                function sliderObj:Set(value)
                    currentValue = math.clamp(value, minVal, maxVal)
                    local pct = (currentValue - minVal) / (maxVal - minVal)
                    Utility.Tween(sliderFill, { Size = UDim2.new(pct, 0, 1, 0) }, 0.15)
                    Utility.Tween(sliderKnob, { Position = UDim2.new(pct, 0, 0.5, 0) }, 0.15)
                    valueLabel.Text = tostring(currentValue)
                    callback(currentValue)
                end
                function sliderObj:Get()
                    return currentValue
                end

                table.insert(section._elements, sliderObj)
                return sliderObj
            end

            function section:CreateDropdown(cfg)
                local ddName = cfg.Name or "Dropdown"
                local options = cfg.Options or {}
                local isMulti = cfg.Multi or false
                local callback = cfg.Callback or function() end
                local flag = cfg.Flag or ddName
                local selected
                if isMulti then
                    selected = {}
                    if cfg.Default and type(cfg.Default) == "table" then
                        for _, v in ipairs(cfg.Default) do
                            selected[v] = true
                        end
                    end
                else
                    selected = cfg.Default or (options[1] or "")
                end

                local dropdownOpen = false

                local ddFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Dropdown_" .. ddName,
                    BackgroundColor3 = theme.TertiaryBackground,
                    BackgroundTransparency = theme.ElementTransparency,
                    Size = UDim2.new(1, 0, 0, 38),
                    AutomaticSize = Enum.AutomaticSize.Y,
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                    ClipsDescendants = true,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                    Utility.Create("UIStroke", {
                        Color = theme.GlassEnabled and Color3.fromRGB(255, 255, 255) or theme.ElementStrokeColor,
                        Thickness = theme.GlassEnabled and 1 or 0,
                        Transparency = theme.GlassEnabled and 0.5 or 1,
                    }),
                })

                local ddHeader = Utility.Create("TextButton", {
                    Parent = ddFrame,
                    Name = "Header",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 38),
                    Text = "",
                    ZIndex = 5,
                    LayoutOrder = 0,
                })

                Utility.Create("TextLabel", {
                    Parent = ddHeader,
                    Name = "Label",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(0.5, 0, 1, 0),
                    Position = UDim2.new(0, 12, 0, 0),
                    Text = ddName,
                    TextColor3 = theme.Text,
                    TextSize = 13,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 6,
                })

                local function getDisplayText()
                    if isMulti then
                        local items = {}
                        for opt, v in pairs(selected) do
                            if v then table.insert(items, opt) end
                        end
                        if #items == 0 then return "None" end
                        if #items <= 2 then return table.concat(items, ", ") end
                        return items[1] .. ", +" .. (#items - 1)
                    else
                        return tostring(selected)
                    end
                end

                local selectedLabel = Utility.Create("TextLabel", {
                    Parent = ddHeader,
                    Name = "Selected",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(0.45, -12, 1, 0),
                    Position = UDim2.new(0.5, 0, 0, 0),
                    Text = getDisplayText(),
                    TextColor3 = theme.TextDark,
                    TextSize = 12,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Right,
                    TextTruncate = Enum.TextTruncate.AtEnd,
                    ZIndex = 6,
                })

                local arrow = Utility.Create("TextLabel", {
                    Parent = ddHeader,
                    Name = "Arrow",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(0, 20, 1, 0),
                    Position = UDim2.new(1, -28, 0, 0),
                    Text = "‚ñº",
                    TextColor3 = theme.TextDimmed,
                    TextSize = 10,
                    Font = Enum.Font.GothamBold,
                    ZIndex = 6,
                    Rotation = 0,
                })

                local optionsContainer = Utility.Create("Frame", {
                    Parent = ddFrame,
                    Name = "Options",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, -16, 0, 0),
                    Position = UDim2.new(0, 8, 0, 42),
                    AutomaticSize = Enum.AutomaticSize.Y,
                    Visible = false,
                    ZIndex = 5,
                }, {
                    Utility.Create("UIListLayout", {
                        Padding = UDim.new(0, 3),
                        SortOrder = Enum.SortOrder.LayoutOrder,
                    }),
                })

                local optionButtons = {}

                local function rebuildOptions()
                    for _, child in ipairs(optionsContainer:GetChildren()) do
                        if child:IsA("TextButton") then
                            child:Destroy()
                        end
                    end
                    optionButtons = {}

                    for i, opt in ipairs(options) do
                        local isSelected = false
                        if isMulti then
                            isSelected = selected[opt] == true
                        else
                            isSelected = selected == opt
                        end

                        local optBtn = Utility.Create("TextButton", {
                            Parent = optionsContainer,
                            Name = "Option_" .. opt,
                            BackgroundColor3 = isSelected and theme.Accent or theme.InputBackground,
                            BackgroundTransparency = isSelected and 0.5 or 0.2,
                            Size = UDim2.new(1, 0, 0, 30),
                            Text = opt,
                            TextColor3 = isSelected and theme.Text or theme.TextDark,
                            TextSize = 13,
                            Font = Enum.Font.Gotham,
                            ZIndex = 6,
                            LayoutOrder = i,
                        }, {
                            Utility.Create("UICorner", { CornerRadius = UDim.new(0, 6) }),
                        })

                        optBtn.MouseEnter:Connect(function()
                            Utility.Tween(optBtn, { BackgroundTransparency = 0.3 }, 0.1)
                        end)
                        optBtn.MouseLeave:Connect(function()
                            local sel = isMulti and (selected[opt] == true) or (selected == opt)
                            Utility.Tween(optBtn, { BackgroundTransparency = sel and 0.5 or 0.2 }, 0.1)
                        end)

                        optBtn.MouseButton1Click:Connect(function()
                            if isMulti then
                                selected[opt] = not selected[opt]
                                if not selected[opt] then selected[opt] = nil end
                                local sel = selected[opt] == true
                                Utility.Tween(optBtn, {
                                    BackgroundColor3 = sel and theme.Accent or theme.InputBackground,
                                    BackgroundTransparency = sel and 0.5 or 0.2,
                                })
                                optBtn.TextColor3 = sel and theme.Text or theme.TextDark
                                selectedLabel.Text = getDisplayText()
                                local result = {}
                                for k, v in pairs(selected) do
                                    if v then table.insert(result, k) end
                                end
                                callback(result)
                            else
                                selected = opt
                                selectedLabel.Text = getDisplayText()
                                for _, ob in ipairs(optionButtons) do
                                    local s = ob._opt == opt
                                    Utility.Tween(ob._btn, {
                                        BackgroundColor3 = s and theme.Accent or theme.InputBackground,
                                        BackgroundTransparency = s and 0.5 or 0.2,
                                    })
                                    ob._btn.TextColor3 = s and theme.Text or theme.TextDark
                                end
                                callback(selected)
                                task.delay(0.1, function()
                                    if dropdownOpen then
                                        ddHeader.MouseButton1Click:Fire()
                                    end
                                end)
                            end
                            if KyuuLibrary.SoundsEnabled then
                                Utility.AddSound("rbxassetid://6026984224", 0.15)
                            end
                        end)

                        table.insert(optionButtons, { _btn = optBtn, _opt = opt })
                    end
                end

                rebuildOptions()

                ddHeader.MouseButton1Click:Connect(function()
                    dropdownOpen = not dropdownOpen
                    optionsContainer.Visible = dropdownOpen

                    Utility.Tween(arrow, { Rotation = dropdownOpen and 180 or 0 }, 0.2)

                    if dropdownOpen then
                        ddFrame.ClipsDescendants = false
                        ddFrame.AutomaticSize = Enum.AutomaticSize.Y
                    else
                        ddFrame.AutomaticSize = Enum.AutomaticSize.None
                        ddFrame.ClipsDescendants = true
                        Utility.Tween(ddFrame, { Size = UDim2.new(1, 0, 0, 38) }, 0.2)
                    end
                end)

                ddFrame.MouseEnter:Connect(function()
                    Utility.Tween(ddFrame, { BackgroundTransparency = theme.ElementTransparency - 0.2 }, 0.15)
                end)
                ddFrame.MouseLeave:Connect(function()
                    Utility.Tween(ddFrame, { BackgroundTransparency = theme.ElementTransparency }, 0.15)
                end)

                Window._configValues[flag] = function()
                    if isMulti then
                        local result = {}
                        for k, v in pairs(selected) do
                            if v then table.insert(result, k) end
                        end
                        return result
                    end
                    return selected
                end

                local ddObj = {}
                function ddObj:Set(value)
                    if isMulti then
                        selected = {}
                        if type(value) == "table" then
                            for _, v in ipairs(value) do selected[v] = true end
                        end
                    else
                        selected = value
                    end
                    selectedLabel.Text = getDisplayText()
                    rebuildOptions()
                    callback(isMulti and value or selected)
                end
                function ddObj:Get()
                    if isMulti then
                        local result = {}
                        for k, v in pairs(selected) do
                            if v then table.insert(result, k) end
                        end
                        return result
                    end
                    return selected
                end
                function ddObj:Refresh(newOptions, newDefault)
                    options = newOptions
                    if newDefault ~= nil then
                        if isMulti then
                            selected = {}
                            if type(newDefault) == "table" then
                                for _, v in ipairs(newDefault) do selected[v] = true end
                            end
                        else
                            selected = newDefault
                        end
                    end
                    selectedLabel.Text = getDisplayText()
                    rebuildOptions()
                end

                table.insert(section._elements, ddObj)
                return ddObj
            end

            function section:CreateInput(cfg)
                local inputName = cfg.Name or "Input"
                local placeholder = cfg.Placeholder or "Enter text..."
                local default = cfg.Default or ""
                local callback = cfg.Callback or function() end
                local flag = cfg.Flag or inputName
                local currentText = default

                local inputFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Input_" .. inputName,
                    BackgroundColor3 = theme.TertiaryBackground,
                    BackgroundTransparency = theme.ElementTransparency,
                    Size = UDim2.new(1, 0, 0, 38),
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                    Utility.Create("UIStroke", {
                        Color = theme.GlassEnabled and Color3.fromRGB(255, 255, 255) or theme.ElementStrokeColor,
                        Thickness = theme.GlassEnabled and 1 or 0,
                        Transparency = theme.GlassEnabled and 0.5 or 1,
                    }),
                })

                Utility.Create("TextLabel", {
                    Parent = inputFrame,
                    Name = "Label",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(0.45, 0, 1, 0),
                    Position = UDim2.new(0, 12, 0, 0),
                    Text = inputName,
                    TextColor3 = theme.Text,
                    TextSize = 13,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 5,
                })

                local textBox = Utility.Create("TextBox", {
                    Parent = inputFrame,
                    Name = "TextBox",
                    BackgroundColor3 = theme.InputBackground,
                    Size = UDim2.new(0.5, -16, 0, 26),
                    Position = UDim2.new(0.5, 4, 0.5, 0),
                    AnchorPoint = Vector2.new(0, 0.5),
                    Text = default,
                    PlaceholderText = placeholder,
                    PlaceholderColor3 = theme.TextDimmed,
                    TextColor3 = theme.Text,
                    TextSize = 13,
                    Font = Enum.Font.Gotham,
                    ClearTextOnFocus = false,
                    ZIndex = 6,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 6) }),
                    Utility.Create("UIStroke", { Color = theme.ElementStrokeColor, Thickness = 1, Transparency = theme.ElementStrokeTransparency }),
                    Utility.Create("UIPadding", { PaddingLeft = UDim.new(0, 8), PaddingRight = UDim.new(0, 8) }),
                })

                textBox.FocusLost:Connect(function()
                    currentText = textBox.Text
                    callback(currentText)
                end)

                textBox.Focused:Connect(function()
                    local stroke = textBox:FindFirstChildOfClass("UIStroke")
                    if stroke then
                        Utility.Tween(stroke, { Color = theme.Accent, Transparency = 0 }, 0.15)
                    end
                end)

                textBox.FocusLost:Connect(function()
                    local stroke = textBox:FindFirstChildOfClass("UIStroke")
                    if stroke then
                        Utility.Tween(stroke, { Color = theme.ElementStrokeColor, Transparency = theme.ElementStrokeTransparency }, 0.15)
                    end
                end)

                inputFrame.MouseEnter:Connect(function()
                    Utility.Tween(inputFrame, { BackgroundTransparency = theme.ElementTransparency - 0.2 }, 0.15)
                end)
                inputFrame.MouseLeave:Connect(function()
                    Utility.Tween(inputFrame, { BackgroundTransparency = theme.ElementTransparency }, 0.15)
                end)

                Window._configValues[flag] = function() return currentText end

                local inputObj = {}
                function inputObj:Set(value)
                    currentText = value
                    textBox.Text = value
                    callback(value)
                end
                function inputObj:Get()
                    return currentText
                end

                table.insert(section._elements, inputObj)
                return inputObj
            end

            function section:CreateKeybind(cfg)
                local kbName = cfg.Name or "Keybind"
                local default = cfg.Default or Enum.KeyCode.Unknown
                local callback = cfg.Callback or function() end
                local flag = cfg.Flag or kbName
                local currentKey = default
                local listening = false

                local kbFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Keybind_" .. kbName,
                    BackgroundColor3 = theme.TertiaryBackground,
                    BackgroundTransparency = theme.ElementTransparency,
                    Size = UDim2.new(1, 0, 0, 38),
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                    Utility.Create("UIStroke", {
                        Color = theme.GlassEnabled and Color3.fromRGB(255, 255, 255) or theme.ElementStrokeColor,
                        Thickness = theme.GlassEnabled and 1 or 0,
                        Transparency = theme.GlassEnabled and 0.5 or 1,
                    }),
                })

                Utility.Create("TextLabel", {
                    Parent = kbFrame,
                    Name = "Label",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, -90, 1, 0),
                    Position = UDim2.new(0, 12, 0, 0),
                    Text = kbName,
                    TextColor3 = theme.Text,
                    TextSize = 13,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 5,
                })

                local keyButton = Utility.Create("TextButton", {
                    Parent = kbFrame,
                    Name = "KeyBtn",
                    BackgroundColor3 = theme.InputBackground,
                    Size = UDim2.new(0, 70, 0, 26),
                    Position = UDim2.new(1, -82, 0.5, 0),
                    AnchorPoint = Vector2.new(0, 0.5),
                    Text = currentKey.Name,
                    TextColor3 = theme.Accent,
                    TextSize = 12,
                    Font = Enum.Font.GothamBold,
                    ZIndex = 6,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 6) }),
                    Utility.Create("UIStroke", { Color = theme.ElementStrokeColor, Thickness = 1, Transparency = 0.5 }),
                })

                keyButton.MouseButton1Click:Connect(function()
                    listening = true
                    keyButton.Text = "..."
                    Utility.Tween(keyButton, { BackgroundColor3 = theme.Accent }, 0.15)
                    keyButton.TextColor3 = theme.Background
                end)

                table.insert(Window._connections, UserInputService.InputBegan:Connect(function(input, processed)
                    if listening then
                        if input.UserInputType == Enum.UserInputType.Keyboard then
                            if input.KeyCode == Enum.KeyCode.Escape then
                                listening = false
                                keyButton.Text = currentKey.Name
                                Utility.Tween(keyButton, { BackgroundColor3 = theme.InputBackground }, 0.15)
                                keyButton.TextColor3 = theme.Accent
                            else
                                currentKey = input.KeyCode
                                listening = false
                                keyButton.Text = currentKey.Name
                                Utility.Tween(keyButton, { BackgroundColor3 = theme.InputBackground }, 0.15)
                                keyButton.TextColor3 = theme.Accent
                            end
                        end
                    elseif not processed and input.UserInputType == Enum.UserInputType.Keyboard then
                        if input.KeyCode == currentKey then
                            callback()
                        end
                    end
                end))

                kbFrame.MouseEnter:Connect(function()
                    Utility.Tween(kbFrame, { BackgroundTransparency = theme.ElementTransparency - 0.2 }, 0.15)
                end)
                kbFrame.MouseLeave:Connect(function()
                    Utility.Tween(kbFrame, { BackgroundTransparency = theme.ElementTransparency }, 0.15)
                end)

                Window._configValues[flag] = function() return currentKey end

                local kbObj = {}
                function kbObj:Set(key)
                    currentKey = key
                    keyButton.Text = key.Name
                end
                function kbObj:Get()
                    return currentKey
                end

                table.insert(section._elements, kbObj)
                return kbObj
            end

            function section:CreateColorpicker(cfg)
                local cpName = cfg.Name or "Colorpicker"
                local default = cfg.Default or Color3.fromRGB(255, 0, 100)
                local callback = cfg.Callback or function() end
                local flag = cfg.Flag or cpName
                local currentColor = default
                local pickerOpen = false

                local cpFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Colorpicker_" .. cpName,
                    BackgroundColor3 = theme.TertiaryBackground,
                    BackgroundTransparency = theme.ElementTransparency,
                    Size = UDim2.new(1, 0, 0, 38),
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                    ClipsDescendants = true,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                    Utility.Create("UIStroke", {
                        Color = theme.GlassEnabled and Color3.fromRGB(255, 255, 255) or theme.ElementStrokeColor,
                        Thickness = theme.GlassEnabled and 1 or 0,
                        Transparency = theme.GlassEnabled and 0.5 or 1,
                    }),
                })

                Utility.Create("TextLabel", {
                    Parent = cpFrame,
                    Name = "Label",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, -60, 0, 38),
                    Position = UDim2.new(0, 12, 0, 0),
                    Text = cpName,
                    TextColor3 = theme.Text,
                    TextSize = 13,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 5,
                })

                local colorPreview = Utility.Create("TextButton", {
                    Parent = cpFrame,
                    Name = "Preview",
                    BackgroundColor3 = currentColor,
                    Size = UDim2.new(0, 32, 0, 22),
                    Position = UDim2.new(1, -44, 0, 8),
                    Text = "",
                    ZIndex = 6,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 6) }),
                    Utility.Create("UIStroke", { Color = theme.Border, Thickness = 1 }),
                })

                local pickerPanel = Utility.Create("Frame", {
                    Parent = cpFrame,
                    Name = "PickerPanel",
                    BackgroundColor3 = theme.InputBackground,
                    Size = UDim2.new(1, -16, 0, 130),
                    Position = UDim2.new(0, 8, 0, 42),
                    Visible = false,
                    ZIndex = 5,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                })

                local hueBar = Utility.Create("Frame", {
                    Parent = pickerPanel,
                    Name = "HueBar",
                    BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                    Size = UDim2.new(1, -20, 0, 16),
                    Position = UDim2.new(0, 10, 0, 100),
                    ZIndex = 6,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 4) }),
                    Utility.Create("UIGradient", {
                        Color = ColorSequence.new({
                            ColorSequenceKeypoint.new(0, Color3.fromHSV(0, 1, 1)),
                            ColorSequenceKeypoint.new(0.167, Color3.fromHSV(0.167, 1, 1)),
                            ColorSequenceKeypoint.new(0.333, Color3.fromHSV(0.333, 1, 1)),
                            ColorSequenceKeypoint.new(0.5, Color3.fromHSV(0.5, 1, 1)),
                            ColorSequenceKeypoint.new(0.667, Color3.fromHSV(0.667, 1, 1)),
                            ColorSequenceKeypoint.new(0.833, Color3.fromHSV(0.833, 1, 1)),
                            ColorSequenceKeypoint.new(1, Color3.fromHSV(1, 1, 1)),
                        }),
                    }),
                })

                local h, s, v = currentColor:ToHSV()

                local svField = Utility.Create("Frame", {
                    Parent = pickerPanel,
                    Name = "SVField",
                    BackgroundColor3 = Color3.fromHSV(h, 1, 1),
                    Size = UDim2.new(1, -20, 0, 85),
                    Position = UDim2.new(0, 10, 0, 8),
                    ZIndex = 6,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 6) }),
                })

                Utility.Create("UIGradient", {
                    Parent = svField,
                    Color = ColorSequence.new({
                        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
                        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 255, 255)),
                    }),
                    Transparency = NumberSequence.new({
                        NumberSequenceKeypoint.new(0, 0),
                        NumberSequenceKeypoint.new(1, 1),
                    }),
                })

                Utility.Create("Frame", {
                    Parent = svField,
                    Name = "BlackOverlay",
                    BackgroundColor3 = Color3.fromRGB(0, 0, 0),
                    Size = UDim2.new(1, 0, 1, 0),
                    ZIndex = 7,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 6) }),
                    Utility.Create("UIGradient", {
                        Transparency = NumberSequence.new({
                            NumberSequenceKeypoint.new(0, 1),
                            NumberSequenceKeypoint.new(1, 0),
                        }),
                        Rotation = 90,
                    }),
                })

                local svCursor = Utility.Create("Frame", {
                    Parent = svField,
                    Name = "Cursor",
                    BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                    Size = UDim2.new(0, 10, 0, 10),
                    Position = UDim2.new(s, 0, 1 - v, 0),
                    AnchorPoint = Vector2.new(0.5, 0.5),
                    ZIndex = 9,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(1, 0) }),
                    Utility.Create("UIStroke", { Color = Color3.fromRGB(0, 0, 0), Thickness = 1 }),
                })

                local hueCursor = Utility.Create("Frame", {
                    Parent = hueBar,
                    Name = "Cursor",
                    BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                    Size = UDim2.new(0, 4, 1, 4),
                    Position = UDim2.new(h, 0, 0.5, 0),
                    AnchorPoint = Vector2.new(0.5, 0.5),
                    ZIndex = 8,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 2) }),
                    Utility.Create("UIStroke", { Color = Color3.fromRGB(0, 0, 0), Thickness = 1 }),
                })

                local function updateColor()
                    currentColor = Color3.fromHSV(h, s, v)
                    colorPreview.BackgroundColor3 = currentColor
                    svField.BackgroundColor3 = Color3.fromHSV(h, 1, 1)
                    svCursor.Position = UDim2.new(s, 0, 1 - v, 0)
                    hueCursor.Position = UDim2.new(h, 0, 0.5, 0)
                    callback(currentColor)
                end

                local svDragging = false
                local svInput = Utility.Create("TextButton", {
                    Parent = svField,
                    Name = "Input",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 1, 0),
                    Text = "",
                    ZIndex = 10,
                })

                svInput.MouseButton1Down:Connect(function()
                    svDragging = true
                end)

                table.insert(Window._connections, UserInputService.InputChanged:Connect(function(input)
                    if svDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                        local absPos = svField.AbsolutePosition
                        local absSize = svField.AbsoluteSize
                        s = math.clamp((input.Position.X - absPos.X) / absSize.X, 0, 1)
                        v = math.clamp(1 - (input.Position.Y - absPos.Y) / absSize.Y, 0, 1)
                        updateColor()
                    end
                end))

                local hueDragging = false
                local hueInput = Utility.Create("TextButton", {
                    Parent = hueBar,
                    Name = "Input",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 1, 0),
                    Text = "",
                    ZIndex = 8,
                })

                hueInput.MouseButton1Down:Connect(function()
                    hueDragging = true
                end)

                table.insert(Window._connections, UserInputService.InputChanged:Connect(function(input)
                    if hueDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                        local absPos = hueBar.AbsolutePosition
                        local absSize = hueBar.AbsoluteSize
                        h = math.clamp((input.Position.X - absPos.X) / absSize.X, 0, 0.999)
                        updateColor()
                    end
                end))

                table.insert(Window._connections, UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        svDragging = false
                        hueDragging = false
                    end
                end))

                colorPreview.MouseButton1Click:Connect(function()
                    pickerOpen = not pickerOpen
                    pickerPanel.Visible = pickerOpen

                    if pickerOpen then
                        cpFrame.ClipsDescendants = false
                        Utility.Tween(cpFrame, { Size = UDim2.new(1, 0, 0, 180) }, 0.2)
                    else
                        Utility.Tween(cpFrame, { Size = UDim2.new(1, 0, 0, 38) }, 0.2)
                        task.delay(0.2, function()
                            cpFrame.ClipsDescendants = true
                        end)
                    end
                end)

                cpFrame.MouseEnter:Connect(function()
                    Utility.Tween(cpFrame, { BackgroundTransparency = theme.ElementTransparency - 0.2 }, 0.15)
                end)
                cpFrame.MouseLeave:Connect(function()
                    Utility.Tween(cpFrame, { BackgroundTransparency = theme.ElementTransparency }, 0.15)
                end)

                Window._configValues[flag] = function() return currentColor end

                local cpObj = {}
                function cpObj:Set(color)
                    currentColor = color
                    h, s, v = color:ToHSV()
                    updateColor()
                end
                function cpObj:Get()
                    return currentColor
                end

                table.insert(section._elements, cpObj)
                return cpObj
            end

            function section:CreateLabel(text)
                local labelFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Label",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 24),
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                })

                local label = Utility.Create("TextLabel", {
                    Parent = labelFrame,
                    Name = "Text",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 1, 0),
                    Position = UDim2.new(0, 6, 0, 0),
                    Text = text,
                    TextColor3 = theme.TextDark,
                    TextSize = 13,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 5,
                })

                local labelObj = {}
                function labelObj:Set(newText)
                    label.Text = newText
                end
                table.insert(section._elements, labelObj)
                return labelObj
            end

            function section:CreateParagraph(cfg)
                local pTitle = cfg.Title or "Paragraph"
                local pContent = cfg.Content or ""

                local paraFrame = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Paragraph_" .. pTitle,
                    BackgroundColor3 = theme.TertiaryBackground,
                    BackgroundTransparency = theme.ElementTransparency,
                    Size = UDim2.new(1, 0, 0, 0),
                    AutomaticSize = Enum.AutomaticSize.Y,
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                }, {
                    Utility.Create("UICorner", { CornerRadius = UDim.new(0, 8) }),
                    Utility.Create("UIPadding", {
                        PaddingTop = UDim.new(0, 10),
                        PaddingBottom = UDim.new(0, 10),
                        PaddingLeft = UDim.new(0, 12),
                        PaddingRight = UDim.new(0, 12),
                    }),
                    Utility.Create("UIListLayout", {
                        Padding = UDim.new(0, 4),
                        SortOrder = Enum.SortOrder.LayoutOrder,
                    }),
                })

                local titleLbl = Utility.Create("TextLabel", {
                    Parent = paraFrame,
                    Name = "Title",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 18),
                    Text = pTitle,
                    TextColor3 = theme.Text,
                    TextSize = 14,
                    Font = Enum.Font.GothamBold,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 5,
                    LayoutOrder = 1,
                })

                local contentLbl = Utility.Create("TextLabel", {
                    Parent = paraFrame,
                    Name = "Content",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 0),
                    AutomaticSize = Enum.AutomaticSize.Y,
                    Text = pContent,
                    TextColor3 = theme.TextDark,
                    TextSize = 13,
                    Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    TextWrapped = true,
                    ZIndex = 5,
                    LayoutOrder = 2,
                })

                local paraObj = {}
                function paraObj:Set(cfg2)
                    if cfg2.Title then titleLbl.Text = cfg2.Title end
                    if cfg2.Content then contentLbl.Text = cfg2.Content end
                end
                table.insert(section._elements, paraObj)
                return paraObj
            end

            function section:CreateSeparator()
                local sep = Utility.Create("Frame", {
                    Parent = sectionFrame,
                    Name = "Separator",
                    BackgroundColor3 = theme.Border,
                    BackgroundTransparency = 0.5,
                    Size = UDim2.new(1, -8, 0, 1),
                    LayoutOrder = #section._elements + 1,
                    ZIndex = 4,
                })

                table.insert(section._elements, { _frame = sep })
                return sep
            end

            table.insert(tabData._sections, section)
            return section
        end

        function tabData:CreateSmallSection(sectionName)
            local sec = tabData:CreateSection(sectionName)
            local f = sec._frame
            if f then
                local stroke = f:FindFirstChildOfClass("UIStroke")
                if stroke then stroke.Thickness = 0 end
                f.BackgroundTransparency = 0.7
                local header = f:FindFirstChild("Header")
                if header then
                    header.TextSize = 11
                    header.TextColor3 = theme.TextDimmed
                end
            end
            return sec
        end

        table.insert(self._tabs, tabData)
        return tabData
    end

    if saveConfig then
        task.defer(function()
            Window:LoadConfig()
        end)
    end

    table.insert(self.Windows, Window)
    return Window
end

function KyuuLibrary:Destroy()
    for _, window in ipairs(self.Windows) do
        window:Destroy()
    end
    self.Windows = {}

    for _, conn in ipairs(self.Connections) do
        if typeof(conn) == "RBXScriptConnection" then
            conn:Disconnect()
        end
    end
    self.Connections = {}
    self.CustomKeybinds = {}

    if self.ScreenGui then
        self.ScreenGui:Destroy()
        self.ScreenGui = nil
    end
end

function KyuuLibrary:RegisterTheme(name, themeData)
    Themes[name] = themeData
end

return KyuuLibrary
